#define _GNU_OURCE

#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

#include "coverhunt.h"

#include "../stringop.h"
#include "../core.h"
#include "../core.h"


const char * cover_coverhunt_url(glyr_settings_t * sets)
{
    if(sets->cover.min_size <= 500 || sets->cover.min_size)
        return "http://www.coverhunt.com/index.php?query=%artist%+%album%&action=Find+my+CD+Covers";

    return NULL;
}

static bool check_size(const char * art_root, const char *hw, cb_object * capo)
{
    char * begin = strstr(art_root,hw);
    if(begin)
    {
        char * end = strchr(begin,' ');
	char * buf = copy_value(begin+strlen(hw),end);
        if(buf)
        {
            int atoid = atoi(buf);

            free(buf);
            if((atoid >= capo->s->cover.min_size || capo->s->cover.min_size == -1) &&
               (atoid <= capo->s->cover.max_size || capo->s->cover.max_size == -1)  )
                return true;
        }
    }
    return false;
}

#define SEARCH_RESULT_BEGIN "<table><tr><td"
#define IMG_START "<img src=\""
#define NODE_BEGIN "<a href=\"/go/"

// Take the first link we find.
// coverhunt sadly offers  no way to check if the
// image is really related to the query we're searching for
cache_list * cover_coverhunt_parse(cb_object *capo)
{
    cache_list * r_list = NULL;

    // navigate to start of search results
    char * table_start;
    if( (table_start = strstr(capo->cache->data,SEARCH_RESULT_BEGIN)) == NULL)
    {
        return NULL;
    }
    
    int urlc = 0;

    while( (table_start = strstr(table_start + 1,NODE_BEGIN)) && urlc < capo->s->number && urlc < capo->s->plugmax)
    {
	    char * table_end = NULL;
	    if( (table_end = strstr(table_start,"\">")) != NULL)
	    {
		char * go_url = copy_value(table_start + strlen(NODE_BEGIN),table_end);
		if(go_url)
		{
		    char * real_url = strdup_printf("http://www.coverhunt.com/go/%s",go_url);
		    if(real_url)
		    {
			memCache_t * search_buf = download_single(real_url,capo->s);
			if(search_buf)
			{
			    char * artwork = strstr(search_buf->data, "<div class=\"artwork\">");
			    if(artwork)
			    {
				if(check_size(artwork,"height=",capo) && check_size(artwork,"width=",capo))
				{
					char * img_start = strstr(artwork,IMG_START);
					if(img_start)
					{
						img_start += strlen(IMG_START);
						char * img_end = strstr(img_start,"\" ");
						if(img_end)
						{
							char * url = copy_value(img_start,img_end);
							if(url)
							{
								if(!r_list) r_list = DL_new_lst();
	
								memCache_t * shell = DL_init();
								shell->data = url;
								shell->size = img_end - img_start;

								DL_add_to_list(r_list,shell);

								urlc++;
							}
						}
					}
				}
	                    }
			    DL_free(search_buf);
			}
			free(real_url);
		    }
		    free(go_url);
		}
	    }
    }
    return r_list;
}
