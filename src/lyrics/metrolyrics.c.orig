#define _GNU_SOURCE

#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "metrolyrics.h"

#include "../types.h"
#include "../core.h"
#include "../stringop.h"


#define ML_URL "http://www.metrolyrics.com/search.php?search=%artist%+%title%&category=artisttitle"

const char * lyrics_metrolyrics_url(void)
{
    return ML_URL;
}

memCache_t * lyrics_metrolyrics_parse(cb_object * capo)
{
    if( strstr(capo->cache->data,"Found 0 Results in Everything") == NULL)
    {
    	char *p_ref;
    	if( (p_ref = strcasestr(capo->cache->data,"<ul id=\"results\">")) )
	{
	    if( (p_ref = strcasestr(p_ref,"<a href=\"")) != NULL)
	    {
		p_ref += strlen("<a href=\"");
		char * e_ref = strstr(p_ref,"\" title=");

		if(e_ref)
		{
		    size_t b_len = e_ref - p_ref;
		    char * new_ref = malloc(b_len + 1);
		    strncpy(new_ref,p_ref,b_len);
		    new_ref[b_len] = '\0';	

		    char * lyr_url = strdup_printf("http://www.metrolyrics.com%s",new_ref);
		    free(new_ref);

		    if(lyr_url)
		    {
			memCache_t * lyr_cache = download_single(lyr_url,1L);

			free(lyr_url);

			if(lyr_cache && lyr_cache->data)
			{
			    char * l_ptr = strcasestr(lyr_cache->data, "<div id=\"lyrics\">");
			    if(l_ptr)
			    {
				char * dive_ptr = strcasestr(l_ptr,"</div>");
				if(dive_ptr)
				{
				    size_t copy_len =  dive_ptr - l_ptr;
				    char * copy_buf = malloc(copy_len + 1);

				    if(copy_buf && copy_len)
				    {
					strncpy(copy_buf,l_ptr,copy_len);
					copy_buf[copy_len] = '\0';

					memCache_t * r_cache = DL_init();
					if(r_cache)
					{
					    r_cache->data = strreplace(copy_buf,"<br />","");
					    r_cache->size = strlen(r_cache->data);
					    free(copy_buf);
					    return r_cache;
					}
				    }
				}
			    }
			}
		    }
		}
	    }
	}
    }
    return NULL;
}
